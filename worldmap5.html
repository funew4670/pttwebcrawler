<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>World Map 5 - Flat Map Zoom</title>
  <link rel="icon" href="data:;base64,=" />
  <style>
    html, body {
      margin: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: linear-gradient(180deg, #d9ecff 0%, #eef6ff 45%, #f8fbff 100%);
      font-family: "Segoe UI", "Noto Sans TC", sans-serif;
    }

    #app {
      width: 100%;
      height: 100%;
      position: relative;
    }

    svg {
      width: 100%;
      height: 100%;
      display: block;
      cursor: grab;
      touch-action: none;
    }

    svg:active {
      cursor: grabbing;
    }

    .country {
      fill: #76b37f;
      stroke: #ffffff;
      stroke-width: 0.6;
      vector-effect: non-scaling-stroke;
      transition: fill 0.2s ease;
    }

    .country:hover {
      fill: #5da86b;
    }

    .country.selected {
      fill: #5ea96d;
      stroke: #ffe082;
      stroke-width: 1.2;
    }

    .floating-country {
      fill: #2f8d48;
      stroke: #ffe082;
      stroke-width: 1.6;
      vector-effect: non-scaling-stroke;
      filter: drop-shadow(0 8px 10px rgba(0, 0, 0, 0.25));
      pointer-events: none;
    }

    #countryName {
      position: absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      font-size: 16px;
      font-weight: 600;
      color: #1e2a36;
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    #countryName.visible {
      opacity: 1;
    }

    #status {
      position: absolute;
      left: 12px;
      bottom: 12px;
      padding: 6px 10px;
      font-size: 12px;
      color: #1e2a36;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 8px;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="app">
    <svg id="map" aria-label="Flat world map"></svg>
    <div id="countryName"></div>
    <div id="status">載入地圖中...</div>
  </div>

  <script type="module">
    import * as d3 from 'https://cdn.jsdelivr.net/npm/d3@7/+esm';

    const svg = d3.select('#map');
    const statusEl = document.getElementById('status');
    const countryNameEl = document.getElementById('countryName');
    const g = svg.append('g');
    const mapLayer = g.append('g');
    const focusLayer = g.append('g');

    const projection = d3.geoNaturalEarth1();
    const path = d3.geoPath(projection);

    let worldData = null;
    let countryPaths = null;
    let selectedFeature = null;

    const zoom = d3.zoom()
      .scaleExtent([1, 12])
      .on('zoom', (event) => {
        g.attr('transform', event.transform);
      });

    function getViewSize() {
      const rect = svg.node().getBoundingClientRect();
      return {
        width: Math.max(320, rect.width),
        height: Math.max(240, rect.height)
      };
    }

    function getFloatingTransform(feature, scale) {
      const centroid = path.centroid(feature);
      return `translate(${centroid[0]},${centroid[1]}) scale(${scale}) translate(${-centroid[0]},${-centroid[1]})`;
    }

    function getFloatingScale(feature) {
      const { width, height } = getViewSize();
      const bounds = path.bounds(feature);
      const dx = Math.max(1, bounds[1][0] - bounds[0][0]);
      const dy = Math.max(1, bounds[1][1] - bounds[0][1]);
      const targetW = width * 0.3;
      const targetH = height * 0.3;
      const scale = Math.min(targetW / dx, targetH / dy);
      return Math.max(1.05, Math.min(8, scale));
    }

    function showCountryName(name) {
      countryNameEl.textContent = name;
      countryNameEl.classList.add('visible');
    }

    function hideCountryName() {
      countryNameEl.classList.remove('visible');
      countryNameEl.textContent = '';
    }

    function drawFloatingCountry(feature, animate = true) {
      if (!feature) {
        focusLayer.selectAll('path.floating-country')
          .transition()
          .duration(180)
          .style('opacity', 0)
          .remove();
        return;
      }

      const floating = focusLayer.selectAll('path.floating-country')
        .data([feature]);
      const floatingScale = getFloatingScale(feature);

      floating.join(
        (enter) => enter.append('path')
          .attr('class', 'floating-country')
          .attr('d', path)
          .attr('transform', getFloatingTransform(feature, 1))
          .style('opacity', 0)
          .call((sel) => {
            if (animate) {
              sel.transition()
                .duration(360)
                .style('opacity', 1)
                .attr('transform', getFloatingTransform(feature, floatingScale));
            } else {
              sel.style('opacity', 1)
                .attr('transform', getFloatingTransform(feature, floatingScale));
            }
          }),
        (update) => update
          .attr('d', path)
          .call((sel) => {
            if (animate) {
              sel.transition()
                .duration(260)
                .style('opacity', 1)
                .attr('transform', getFloatingTransform(feature, floatingScale));
            } else {
              sel.style('opacity', 1)
                .attr('transform', getFloatingTransform(feature, floatingScale));
            }
          }),
        (exit) => exit.remove()
      );
    }

    function focusCountry(feature, animate = true) {
      selectedFeature = feature;
      countryPaths.classed('selected', (d) => d === feature);
      showCountryName(feature?.properties?.name || 'Unknown');
      drawFloatingCountry(feature, animate);
    }

    function resetFocus() {
      selectedFeature = null;
      if (countryPaths) {
        countryPaths.classed('selected', false);
      }
      hideCountryName();
      drawFloatingCountry(null, false);
    }

    function render() {
      const { width, height } = getViewSize();
      projection.fitExtent([[20, 20], [width - 20, height - 20]], worldData);

      countryPaths = mapLayer.selectAll('path.country')
        .data(worldData.features)
        .join(
          (enter) => {
            const p = enter.append('path').attr('class', 'country');
            p.append('title');
            return p;
          },
          (update) => update,
          (exit) => exit.remove()
        )
        .attr('d', path)
        .on('click', (event, d) => {
          event.stopPropagation();
          focusCountry(d, true);
        });

      countryPaths.each(function(d) {
        d3.select(this).select('title').text(d?.properties?.name || 'Unknown');
      });

      if (selectedFeature) {
        focusCountry(selectedFeature, false);
      } else {
        resetFocus();
      }
    }

    async function loadAndRender() {
      try {
        worldData = await d3.json('./countries-110m.fixed.geojson');
        if (!worldData || !Array.isArray(worldData.features)) {
          throw new Error('GeoJSON 格式不正確');
        }

        svg.call(zoom);
        svg.on('click', () => resetFocus());

        render();
        window.addEventListener('resize', render);

        statusEl.textContent = '滑鼠滾輪可縮放；點國家會浮起放大；點空白處還原';
      } catch (err) {
        console.error(err);
        statusEl.textContent = `載入失敗: ${err.message}`;
      }
    }

    loadAndRender();
  </script>
</body>
</html>
